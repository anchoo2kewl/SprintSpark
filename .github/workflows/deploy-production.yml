name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (commit SHA, tag, or branch)'
        required: false
        default: 'main'
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    if: github.event.inputs.confirm == 'deploy'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Display deployment info
        run: |
          echo "Deploying to PRODUCTION"
          echo "Ref: ${{ github.event.inputs.ref }}"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Triggered by: ${{ github.actor }}"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Sync code to production
        run: |
          rsync -azP --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='api/tmp' \
            --exclude='api/data' \
            --exclude='web/dist' \
            --exclude='.env' \
            --exclude='.claude' \
            --exclude='.entire' \
            --exclude='deployment/inventory.yml' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/${{ secrets.SERVER_USER }}/sprintspark/source/

      - name: Deploy production on server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -e
            APP_DIR=/home/${{ secrets.SERVER_USER }}/sprintspark

            echo "=== Deploying SprintSpark to PRODUCTION ==="

            echo "-> Building Docker images..."
            cd "$APP_DIR"
            docker compose build --no-cache

            echo "-> Restarting containers..."
            docker compose down
            docker compose up -d

            echo "-> Waiting for services..."
            sleep 10

            # Health check API (production port 8081)
            echo "-> Checking API health..."
            for i in $(seq 1 30); do
              if curl -sf http://127.0.0.1:8081/api/health > /dev/null 2>&1; then
                echo "OK: API is healthy"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "FAIL: API health check failed"
                docker compose logs api | tail -20
                exit 1
              fi
              sleep 2
            done

            # Health check web (production port 8085)
            echo "-> Checking web health..."
            for i in $(seq 1 30); do
              if curl -sf http://127.0.0.1:8085/health > /dev/null 2>&1; then
                echo "OK: Web is healthy"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "FAIL: Web health check failed"
                docker compose logs web | tail -20
                exit 1
              fi
              sleep 2
            done

            # Health check MCP (production port 8083)
            echo "-> Checking MCP health..."
            for i in $(seq 1 30); do
              if curl -sf http://127.0.0.1:8083/health > /dev/null 2>&1; then
                echo "OK: MCP is healthy"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "FAIL: MCP health check failed"
                docker compose logs mcp | tail -20
                exit 1
              fi
              sleep 2
            done

            echo "-> Cleaning up old Docker images..."
            docker image prune -f

            echo ""
            echo "=== Production deployment completed! ==="
            echo "URL: https://taskai.cc"
